db: test_db
cases:
  - desc: single_window_test_8746446a-54d8-11eb-8418-186590d606f5
    tags: ["@baoxinqi, 这部分输出为空是不是这些聚合特征本身构造有问题，是否需要修改auto case"]
    id: 0
    inputs:
      - columns:
          - id int64
          - pk_0_int64 int64
          - pk_1_date date
          - order_0_timestamp timestamp
          - order_1_timestamp timestamp
          - c_0_int32 int32
          - c_1_bool bool
          - c_2_timestamp timestamp
          - c_3_int64 int64
          - c_4_int16 int16
          - c_5_string string
          - c_6_double double
          - c_7_bool bool
          - c_8_timestamp timestamp
          - c_9_timestamp timestamp
          - c_10_timestamp timestamp
          - c_11_int16 int16
        indexs:
          - index0:pk_1_date:order_0_timestamp
          - index1:pk_1_date:order_1_timestamp
          - index2:pk_0_int64:order_0_timestamp
        rows:
          - - 0
            - -9223372036854775808
            - '2006-04-17'
            - 1610425561936
            - 1610341418315
            - null
            - true
            - 859537737621
            - 0
            - null
            - 5NkB6778wLVAP1OeACTZnlkY0n0ZszR
            - 0.0
            - true
            - 656949677991
            - null
            - 969126770332
            - 32767
      - columns:
          - id int64
          - pk_0_int64 int64
          - pk_1_date date
          - order_0_timestamp timestamp
          - order_1_timestamp timestamp
          - c_0_int32 int32
          - c_1_bool bool
          - c_2_timestamp timestamp
          - c_3_int64 int64
          - c_4_int16 int16
          - c_5_string string
          - c_6_double double
          - c_7_bool bool
          - c_8_timestamp timestamp
          - c_9_timestamp timestamp
          - c_10_timestamp timestamp
          - c_11_int16 int16
        indexs:
          - index0:pk_1_date:order_0_timestamp
          - index1:pk_1_date:order_1_timestamp
          - index2:pk_0_int64:order_0_timestamp
        rows:
          - - 0
            - 9223372036854775807
            - '1995-01-21'
            - 1610347357659
            - 1610251452460
            - 1
            - null
            - 20962580035
            - 9223372036854775807
            - -1749
            - E3LqkOrI3PDNMrLr0IItkMVswNGi5rKExYpTg3TbhGyd4
            - 1
            - null
            - 178377574142
            - null
            - 375060570903
            - -2243
    sql: |
      SELECT
        id, pk_0_int64, pk_1_date, order_0_timestamp, order_1_timestamp,
        top_n_key_max_cate_where(c_0_int32, c_1_bool, ifnull(c_2_timestamp, c_2_timestamp),if_null(at(c_3_int64, c_0_int32), c_3_int64)) OVER w2 AS w2_out_0,
        avg_cate_where(c_4_int16,c_1_bool, if_null(c_5_string, c_5_string)) OVER w0 AS w0_out_1,
        min_cate_where(pow(c_6_double,c_6_double), maximum(c_1_bool, c_7_bool), minimum(min(c_8_timestamp), c_9_timestamp)) OVER w0 AS w0_out_2,
        top_n_key_sum_cate_where(c_6_double, (is_null(c_6_double) + isnull(c_10_timestamp)), round(distinct_count(c_11_int16)), inc(c_0_int32)) OVER w0 AS w0_out_3
      FROM {0} WINDOW
        w0 AS (UNION {1} PARTITION BY pk_1_date ORDER BY order_0_timestamp ROWS_RANGE BETWEEN 3d PRECEDING AND CURRENT ROW ),
        w1 AS (UNION {1} PARTITION BY pk_0_int64 ORDER BY order_0_timestamp ROWS_RANGE BETWEEN 3m PRECEDING AND CURRENT ROW ),
        w2 AS (PARTITION BY pk_1_date ORDER BY order_1_timestamp ROWS_RANGE BETWEEN 3h PRECEDING AND CURRENT ROW);
    expect:
      order: id
      success: true
  - desc: Ambiguous column resolved in schema context
    id: 1
    tags: ["TODO", "@baoxinqi, Ambiguous column name order_0_timestamp",
           "pls add one simple case into integration/v1 after you fix it"]
    inputs:
      - columns:
          - id int64
          - pk_0_int64 int64
          - pk_1_date date
          - order_0_timestamp timestamp
          - order_1_timestamp timestamp
          - c_0_int32 int32
          - c_1_bool bool
          - c_2_timestamp timestamp
          - c_3_int64 int64
          - c_4_int16 int16
          - c_5_string string
          - c_6_double double
          - c_7_bool bool
          - c_8_timestamp timestamp
          - c_9_timestamp timestamp
          - c_10_timestamp timestamp
          - c_11_int16 int16
        indexs:
          - index0:pk_1_date:order_0_timestamp
          - index1:pk_1_date:order_1_timestamp
          - index2:pk_0_int64:order_0_timestamp
        rows:
          - - 0
            - -9223372036854775808
            - '2006-04-17'
            - 1610425561936
            - 1610341418315
            - null
            - true
            - 859537737621
            - 0
            - null
            - 5NkB6778wLVAP1OeACTZnlkY0n0ZszR
            - 0.0
            - true
            - 656949677991
            - null
            - 969126770332
            - 32767
      - columns:
          - id int64
          - pk_0_int64 int64
          - pk_1_date date
          - order_0_timestamp timestamp
          - order_1_timestamp timestamp
          - c_0_int32 int32
          - c_1_bool bool
          - c_2_timestamp timestamp
          - c_3_int64 int64
          - c_4_int16 int16
          - c_5_string string
          - c_6_double double
          - c_7_bool bool
          - c_8_timestamp timestamp
          - c_9_timestamp timestamp
          - c_10_timestamp timestamp
          - c_11_int16 int16
        indexs:
          - index0:pk_1_date:order_0_timestamp
          - index1:pk_1_date:order_1_timestamp
          - index2:pk_0_int64:order_0_timestamp
        rows:
          - - 0
            - 9223372036854775807
            - '1995-01-21'
            - 1610347357659
            - 1610251452460
            - 1
            - null
            - 20962580035
            - 9223372036854775807
            - -1749
            - E3LqkOrI3PDNMrLr0IItkMVswNGi5rKExYpTg3TbhGyd4
            - 1
            - null
            - 178377574142
            - null
            - 375060570903
            - -2243
    sql: |
      SELECT
        id, pk_0_int64, pk_1_date, order_0_timestamp, order_1_timestamp, order_0_timestamp,
        top_n_key_max_cate_where(c_0_int32, c_1_bool, ifnull(c_2_timestamp, c_2_timestamp),if_null(at(c_3_int64, c_0_int32), c_3_int64)) OVER w2 AS w2_out_0,
        top_n_key_sum_cate_where(c_6_double, (is_null(c_6_double) + isnull(c_10_timestamp)), round(distinct_count(c_11_int16)), inc(c_0_int32)) OVER w0 AS w0_out_3
      FROM {0} WINDOW
        w0 AS (UNION {1} PARTITION BY pk_1_date ORDER BY order_0_timestamp ROWS_RANGE BETWEEN 3d PRECEDING AND CURRENT ROW ),
        w1 AS (UNION {1} PARTITION BY pk_0_int64 ORDER BY order_0_timestamp ROWS_RANGE BETWEEN 3m PRECEDING AND CURRENT ROW ),
        w2 AS (PARTITION BY pk_1_date ORDER BY order_1_timestamp ROWS_RANGE BETWEEN 3h PRECEDING AND CURRENT ROW);
    expect:
      order: id
      success: true