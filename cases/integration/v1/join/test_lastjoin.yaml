db: test_zw
debugs: []
cases:
  - id: 0
    desc: lastjoin+窗口
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c4,
      sum({1}.c4) OVER w1 as w1_c4_sum
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      WINDOW
      w1 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,32,32]
        - [2,"aa",21,32,64]
        - [3,"aa",22,32,64]
        - [4,"bb",23,34,34]
        - [5,"bb",24,34,68]
  - id: 1
    desc: lastjoin+窗口-没有匹配的列
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"cc",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"cc",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c4,
      sum({1}.c4) OVER w1 as w1_c4_sum,
      count({1}.c4) OVER w1 as w1_c4_count
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      WINDOW
      w1 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","w1_c4_sum bigint","w1_c4_count bigint"]
      rows:
        - [1,"aa",20,32,32,1]
        - [2,"aa",21,32,64,2]
        - [3,"aa",22,32,64,2]
        - [4,"bb",23,null,0,0]
        - [5,"bb",24,null,0,0]
  - id: 2
    desc: lastjoin+窗口+union
    tags: ["TODO","暂时不支持 lastjoin window + union共存"]
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["d1 string","d4 bigint","d7 timestamp"]
        indexs: ["index1:d1:d7"]
        rows:
          - ["aa",30,1590738990000]
          - ["aa",32,1590738990002]
          - ["bb",34,1590738990004]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date","d1 string","d4 bigint","d7 timestamp"]
        indexs: ["index1:c1:c7"]
        rows:
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02","aa",31,1590738990001]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04","bb",32,1590738990003]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.d4,
      sum({1}.d4) OVER w1 as w1_c4_sum
      from {0}
      last join {1} ORDER BY {1}.d7 on {0}.c1={1}.d1
      WINDOW
      w1 AS (UNION {2} PARTITION BY {0}.c1 ORDER BY {0}.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","d4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,32,32]
        - [3,"aa",22,32,63]
        - [5,"bb",24,34,67]
  - id: 3
    desc: lastjoin+窗口+union子查询
    tags: ["TODO","暂时不支持 lastjoin window + union共存"]
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["d1 string","d4 bigint","d7 timestamp"]
        indexs: ["index1:d1:d7"]
        rows:
          - ["aa",30,1590738990000]
          - ["aa",32,1590738990002]
          - ["bb",34,1590738990004]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date","d4 bigint"]
        indexs: ["index1:c1:c7"]
        rows:
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02",31]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04",32]
      -
        columns: ["d1 string","d7 timestamp"]
        indexs: ["index1:d1:d7"]
        rows:
          - ["aa",1590738990001]
          - ["bb",1590738990003]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.d4,
      sum({1}.d4) OVER w1 as w1_c4_sum
      from {0}
      last join {1} ORDER BY {1}.d7 on {0}.c1={1}.d1
      WINDOW
      w1 AS (UNION
      (select id,c1,c3,c4,c5,c6,c7,c8,d1,d4,d7 from {2} last join {3} ORDER BY {3}.d7 on {2}.c1={3}.d1)
      PARTITION BY {0}.c1 ORDER BY {0}.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","d4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,32,32]
        - [3,"aa",22,32,63]
        - [5,"bb",24,34,67]
  - id: 4
    desc: lastjoin-一个子查询
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,{0}.c1,{0}.c3,t1.c4,
      sum(t1.c4) OVER w1 as w1_c4_sum
      from {0}
      last join (select c1,c4,c7 from {1}) as t1 ORDER BY t1.c7 on {0}.c1=t1.c1
      WINDOW
      w1 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,32,32]
        - [2,"aa",21,32,64]
        - [3,"aa",22,32,64]
        - [4,"bb",23,34,34]
        - [5,"bb",24,34,68]
  - id: 5
    desc: 两个子查询lastjoin
    tags: ["TODO","请求模式下，sdk core"]
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,t2.c1,t2.c3,t1.c4,
      sum(t1.c4) OVER w1 as w1_c4_sum
      from (select id,c1,c3,c4,c7 from {0}) as t2
      last join (select c1,c4,c7 from {1}) as t1 ORDER BY t1.c7 on t2.c1=t1.c1
      WINDOW
      w1 AS (PARTITION BY t2.c1 ORDER BY t2.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,32,32]
        - [2,"aa",21,32,64]
        - [3,"aa",22,32,64]
        - [4,"bb",23,34,34]
        - [5,"bb",24,34,68]
  - id: 6
    desc: 两个子查询lastjoin-子查询带窗口特征
    tags: ["sql执行失败"]
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"aa",22,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",23,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",24,34,1.2,2.2,1590738990004,"2020-05-02"]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,t2.c1,t2.c3,t1.c4,
      sum(t1.c4) OVER w1 as w1_c4_sum,
      sum(t2.w2_c3_sum) OVER w1 as w2_c3_sum,
      sum(t1.w3_c4_sum) OVER w1 as w3_c4_sum
      from (select id,c1,c3,c4,c7,sum({0}.c3) OVER w2 as w2_c3_sum from {0} WINDOW w2 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 ROWS BETWEEN 1 PRECEDING AND CURRENT ROW)) as t2
      last join (select c1,c4,c7,sum({1}.c4) OVER w3 as w3_c4_sum from {1}  WINDOW w3 AS (PARTITION BY {1}.c1 ORDER BY {1}.c7 ROWS_RANGE BETWEEN 1 PRECEDING AND CURRENT ROW)) as t1
      ORDER BY t1.c7 on t2.c1=t1.c1
      WINDOW
      w1 AS (PARTITION BY t2.c1 ORDER BY t2.c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,32,32,20,63]
        - [2,"aa",21,32,64,61,126]
        - [3,"aa",22,32,64,84,126]
        - [4,"bb",23,34,34,23,67]
        - [5,"bb",24,34,68,70,134]
  - id: 7
    desc: lastjoin-ts-null
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,null,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c4
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint"]
      rows:
        - [1,"aa",20,31]
        - [2,"aa",21,31]
        - [3,"aa",22,31]
        - [4,"bb",23,34]
        - [5,"bb",24,34]
  - id: 8
    desc: lastjoin三张表
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"bb",21,31,1.2,2.2,1590738991000,"2020-05-02"]
          - [3,"cc",22,32,1.3,2.3,1590738992000,"2020-05-03"]
          - [4,"dd",23,33,1.4,2.4,1590738993000,"2020-05-04"]
          - [5,"ee",24,34,1.5,2.5,1590738994000,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755660000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1606755720000,"2020-05-01"]
          - [3,"cc",20,32,1.1,2.1,1606755780000,"2020-05-01"]
          - [4,"dd",20,33,1.1,2.1,1606755840000,"2020-05-01"]
          - [5,"ee",21,34,1.2,2.2,1606755660000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755600000,"2020-05-01"]
          - [2,"bb",20,31,1.2,2.1,1606759200000,"2020-05-01"]
          - [3,"bb",20,32,1.3,2.1,1606762800000,"2020-05-01"]
          - [4,"bb",20,33,1.4,2.1,1606766400000,"2020-05-01"]
          - [5,"ee",21,34,1.5,2.2,1606766400000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"ee",20,30,1.1,2.1,1606752000000,"2020-05-01"]
          - [2,"bb",20,31,1.1,2.2,1606838400000,"2020-05-01"]
          - [3,"ee",20,32,1.1,2.3,1606924800000,"2020-05-01"]
          - [4,"ee",20,33,1.1,2.4,1607011200000,"2020-05-01"]
          - [5,"ee",21,34,1.2,2.5,1606752000000,"2020-05-02"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c4,{2}.c5,{3}.c6
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      last join {2} ORDER BY {2}.c7 on {0}.c1={2}.c1
      last join {3} ORDER BY {3}.c7 on {0}.c1={3}.c1
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double"]
      rows:
        - [1,"aa",20,31,1.1,null]
        - [2,"bb",21,null,1.4,2.2]
        - [3,"cc",22,32,null,null]
        - [4,"dd",23,33,null,null]
        - [5,"ee",24,34,1.5,2.4]
  - id: 9
    desc: lastjoin三张表-5个window
    mode: rtidb-batch-unsupport
    tags: ["TODO","请求模式下，sdk core"]
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738991000,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738992000,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738993000,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738994000,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755660000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1606755720000,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1606755780000,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1606755840000,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1606755660000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755600000,"2020-05-01"]
          - [2,"aa",20,31,1.2,2.1,1606759200000,"2020-05-01"]
          - [3,"bb",20,32,1.3,2.1,1606762800000,"2020-05-01"]
          - [4,"bb",20,33,1.4,2.1,1606766400000,"2020-05-01"]
          - [5,"bb",21,34,1.5,2.2,1606766400000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"bb",20,30,1.1,2.1,1606752000000,"2020-05-01"]
          - [2,"bb",20,31,1.1,2.2,1606838400000,"2020-05-01"]
          - [3,"cc",20,32,1.1,2.3,1606924800000,"2020-05-01"]
          - [4,"ee",20,33,1.1,2.4,1607011200000,"2020-05-01"]
          - [5,"ee",21,34,1.2,2.5,1606752000000,"2020-05-02"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c4,{2}.c5,{3}.c6,
      sum({0}.c4) OVER w1 as w1_c4_sum,
      sum({1}.c4) OVER w2 as w2_c4_sum,
      sum({2}.c4) OVER w3 as w3_c4_sum,
      sum({3}.c4) OVER w4 as w4_c4_sum,
      count({3}.c4) OVER w5 as w5_c4_count
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      last join {2} ORDER BY {2}.c7 on {0}.c1={2}.c1
      last join {3} ORDER BY {3}.c7 on {0}.c1={3}.c1
      WINDOW
      w1 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 ROWS_RANGE BETWEEN 1s PRECEDING AND CURRENT ROW),
      w2 AS (PARTITION BY {0}.c1 ORDER BY {1}.c7 ROWS_RANGE BETWEEN 1m PRECEDING AND CURRENT ROW),
      w3 AS (PARTITION BY {0}.c1 ORDER BY {2}.c7 ROWS_RANGE BETWEEN 1h PRECEDING AND CURRENT ROW),
      w4 AS (PARTITION BY {0}.c1 ORDER BY {3}.c7 ROWS_RANGE BETWEEN 1d PRECEDING AND CURRENT ROW),
      w5 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 ROWS BETWEEN 2 PRECEDING AND CURRENT ROW);
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","w1_c4_sum bigint","w2_c4_sum bigint","w3_c4_sum bigint","w4_c4_sum bigint","w5_c4_count bigint"]
      rows:
        - [1,"aa",20,31,1.1,null,30,32,31,null,0]
        - [2,"aa",21,null,1.4,2.2,61,64,62,null,0]
        - [3,"aa",22,32,null,null,63,64,62,null,0]
        - [4,"bb",23,33,null,null,33,34,34,31,1]
        - [5,"bb",24,34,1.5,2.4,67,68,68,62,2]
  - id: 10
    desc: t1 join t2 join t3,t2的key产出为null
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"bb",21,31,1.2,2.2,1590738991000,"2020-05-02"]
          - [3,"cc",22,32,1.3,2.3,1590738992000,"2020-05-03"]
          - [4,"dd",23,33,1.4,2.4,1590738993000,"2020-05-04"]
          - [5,"ee",24,34,1.5,2.5,1590738994000,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755660000,"2020-05-01"]
          - [2,"aa",21,31,1.1,2.1,1606755720000,"2020-05-01"]
          - [3,"cc",21,32,1.1,2.1,1606755780000,"2020-05-01"]
          - [4,"dd",21,33,1.1,2.1,1606755840000,"2020-05-01"]
          - [5,"ee",24,34,1.2,2.2,1606755660000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755600000,"2020-05-01"]
          - [2,"bb",20,31,1.2,2.1,1606759200000,"2020-05-01"]
          - [3,"bb",null,32,1.3,2.1,1606762800000,"2020-05-01"]
          - [4,"bb",21,33,1.4,2.1,1606766400000,"2020-05-01"]
          - [5,"ee",21,34,1.5,2.2,1606766401000,"2020-05-02"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c3,{2}.c4
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      last join {2} ORDER BY {2}.c7 on {1}.c3={2}.c3
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c3 int","c4 bigint"]
      rows:
        - [1,"aa",20,21,34]
        - [2,"bb",21,null,32]
        - [3,"cc",22,21,34]
        - [4,"dd",23,21,34]
        - [5,"ee",24,24,null]
  - id: 11
    desc: (t1 join t2) join t3
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"bb",21,31,1.2,2.2,1590738991000,"2020-05-02"]
          - [3,"cc",22,32,1.3,2.3,1590738992000,"2020-05-03"]
          - [4,"dd",23,33,1.4,2.4,1590738993000,"2020-05-04"]
          - [5,"ee",24,34,1.5,2.5,1590738994000,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755660000,"2020-05-01"]
          - [2,"aa",21,31,1.1,2.1,1606755720000,"2020-05-01"]
          - [3,"cc",21,32,1.1,2.1,1606755780000,"2020-05-01"]
          - [4,"dd",21,33,1.1,2.1,1606755840000,"2020-05-01"]
          - [5,"ee",24,34,1.2,2.2,1606755660000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755600000,"2020-05-01"]
          - [2,"bb",20,31,1.2,2.1,1606759200000,"2020-05-01"]
          - [3,"bb",null,32,1.3,2.1,1606762800000,"2020-05-01"]
          - [4,"bb",21,33,1.4,2.1,1606766400000,"2020-05-01"]
          - [5,"ee",21,34,1.5,2.2,1606766401000,"2020-05-02"]
    sql: |
      select
      id,t1.c1,t1.c3,{2}.c4
      from (
      select id,{0}.c1,{1}.c3
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      ) as t1 last join {2} ORDER BY {2}.c7 on t1.c3={2}.c3
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint"]
      rows:
        - [1,"aa",21,34]
        - [2,"bb",null,32]
        - [3,"cc",21,34]
        - [4,"dd",21,34]
        - [5,"ee",24,null]
  - id: 12
    desc: t1 join (t2 join t3)
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"bb",21,31,1.2,2.2,1590738991000,"2020-05-02"]
          - [3,"cc",22,32,1.3,2.3,1590738992000,"2020-05-03"]
          - [4,"dd",23,33,1.4,2.4,1590738993000,"2020-05-04"]
          - [5,"ee",24,34,1.5,2.5,1590738994000,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755660000,"2020-05-01"]
          - [2,"aa",21,31,1.1,2.1,1606755720000,"2020-05-01"]
          - [3,"cc",21,32,1.1,2.1,1606755780000,"2020-05-01"]
          - [4,"dd",21,33,1.1,2.1,1606755840000,"2020-05-01"]
          - [5,"ee",24,34,1.2,2.2,1606755660000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755600000,"2020-05-01"]
          - [2,"bb",20,31,1.2,2.1,1606759200000,"2020-05-01"]
          - [3,"bb",null,32,1.3,2.1,1606762800000,"2020-05-01"]
          - [4,"bb",21,33,1.4,2.1,1606766400000,"2020-05-01"]
          - [5,"ee",21,34,1.5,2.2,1606766401000,"2020-05-02"]
    sql: |
      select
      id,{0}.c1,t1.c3,t1.c4
      from
      {0} last join
      (select {1}.c1,{1}.c3,{1}.c7,{2}.c4 from {1} last join {2} order by {2}.c7 on {1}.c3={2}.c3) as t1
      order by t1.c7 on {0}.c1=t1.c1;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint"]
      rows:
        - [1,"aa",21,34]
        - [2,"bb",null,null]
        - [3,"cc",21,34]
        - [4,"dd",21,34]
        - [5,"ee",24,null]
  - id: 13
    desc: t1 join (t2 join t3)-key和ts不是来自同一个主表
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"bb",21,31,1.2,2.2,1590738991000,"2020-05-02"]
          - [3,"cc",22,32,1.3,2.3,1590738992000,"2020-05-03"]
          - [4,"dd",23,33,1.4,2.4,1590738993000,"2020-05-04"]
          - [5,"ee",24,34,1.5,2.5,1590738994000,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755660000,"2020-05-01"]
          - [2,"aa",21,31,1.1,2.1,1606755720000,"2020-05-01"]
          - [3,"cc",21,32,1.1,2.1,1606755780000,"2020-05-01"]
          - [4,"dd",21,33,1.1,2.1,1606755840000,"2020-05-01"]
          - [5,"ee",24,34,1.2,2.2,1606755660000,"2020-05-02"]
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7","index1:c3:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1606755600000,"2020-05-01"]
          - [2,"bb",20,31,1.2,2.1,1606759200000,"2020-05-01"]
          - [3,"bb",null,32,1.3,2.1,1606762800000,"2020-05-01"]
          - [4,"bb",21,33,1.4,2.1,1606766400000,"2020-05-01"]
          - [5,"ee",21,34,1.5,2.2,1606766401000,"2020-05-02"]
    sql: |
      select
      id,{0}.c1,t1.c3,t1.c4
      from
      {0} last join
      (select {1}.c1,{1}.c3,{2}.c7,{2}.c4 from {1} last join {2} order by {2}.c7 on {1}.c3={2}.c3) as t1
      order by t1.c7 on {0}.c1=t1.c1;
    expect:
      success: false
  - id: 14
    desc: lastjoin-重名
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,null,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    sql: |
      select id,{0}.c1,c3,c3,{1}.c4
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c3 int","c4 bigint"]
      rows:
        - [1,"aa",20,20,31]
        - [2,"aa",21,21,31]
        - [3,"aa",22,22,31]
        - [4,"bb",23,23,34]
        - [5,"bb",24,24,34]
  - id: 15
    desc: lastjoin-重名,指定不同的表名
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,null,"2020-05-01"]
          - [3,"aa",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c3,{1}.c4
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c3 int","c4 bigint"]
      rows:
        - [1,"aa",20,20,31]
        - [2,"aa",21,20,31]
        - [3,"aa",22,20,31]
        - [4,"bb",23,21,34]
        - [5,"bb",24,21,34]
  - id: 16
    desc: 两个子查询lastjoin，拼接条件不是主表的索引
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
    sql: |
      select id,t2.c8,t2.c3,t1.c4
      from
      (select id,c1,c3,c4,c7,c8 from {0}) as t2
      last join
      (select c1,c4,c7,c8 from {1}) as t1
      ORDER BY t1.c7 on t2.c8=t1.c8
      ;
    expect:
      success: false
  - id: 17
    desc: 两个子查询lastjoin，order不是主表的ts
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
    sql: |
      select id,t2.c8,t2.c3,t1.c4
      from
      (select id,c1,c3,c4,c7,c8 from {0}) as t2
      last join
      (select c1,c4,c7,c8 from {1}) as t1
      ORDER BY t1.c4 on t2.c1=t1.c1
      ;
    expect:
      success: false
  - id: 18
    desc: 两个子查询lastjoin，拼接条件不是主表的索引-不带orderby
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
    sql: |
      select id,t2.c8,t2.c3,t1.c4
      from
      (select id,c1,c3,c4,c7,c8 from {0}) as t2
      last join
      (select c1,c4,c7,c8 from {1}) as t1
      on t2.c8=t1.c8
      ;
    expect:
      success: false
  - id: 19
    desc: 两个子查询lastjoin-子查询带窗口特征-没有使用索引-不带orderby
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-01"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-01"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-02"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-02"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"aa",22,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",23,33,1.1,2.1,1590738990003,"2020-05-02"]
          - [5,"bb",24,34,1.2,2.2,1590738990004,"2020-05-02"]
    sql: |
      select id,t2.c1,t2.c3,t1.c4
      from (select id,c1,c3,c4,c7,c8,sum({0}.c3) OVER w2 as w2_c3_sum from {0} WINDOW w2 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 ROWS BETWEEN 1 PRECEDING AND CURRENT ROW)) as t2
      last join (select c1,c4,c7,c8,sum({1}.c4) OVER w3 as w3_c4_sum from {1}  WINDOW w3 AS (PARTITION BY {1}.c1 ORDER BY {1}.c7 ROWS_RANGE BETWEEN 1 PRECEDING AND CURRENT ROW)) as t1
      on t2.c8=t1.c8
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint"]
      rows:
        - [1,"aa",20,32,32,20]
        - [2,"aa",21,32,64,61]
        - [3,"aa",22,32,64,84]
        - [4,"bb",23,34,34,23]
        - [5,"bb",24,34,68,70]
  - id: 20
    desc: 两个子查询lastjoin-子查询带窗口特征-没有使用索引-带orderby
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
    sql: |
      select id,t2.c1,t2.c3,t1.c4
      from (select id,c1,c3,c4,c7,c8,sum({0}.c3) OVER w2 as w2_c3_sum from {0} WINDOW w2 AS (PARTITION BY {0}.c1 ORDER BY {0}.c7 ROWS BETWEEN 1 PRECEDING AND CURRENT ROW)) as t2
      last join (select c1,c4,c7,c8,sum({1}.c4) OVER w3 as w3_c4_sum from {1}  WINDOW w3 AS (PARTITION BY {1}.c1 ORDER BY {1}.c7 ROWS_RANGE BETWEEN 1 PRECEDING AND CURRENT ROW)) as t1
      ORDER BY t1.c7 on t2.c8=t1.c8
      ;
    expect:
      success: false
  - id: 21
    desc: lastjoin列名重复-窗口没有指定表名
    inputs:
      -
        columns : ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",21,31,1.2,2.2,1590738990001,"2020-05-02"]
          - [3,"aa",22,32,1.3,2.3,1590738990002,"2020-05-03"]
          - [4,"bb",23,33,1.4,2.4,1590738990003,"2020-05-04"]
          - [5,"bb",24,34,1.5,2.5,1590738990004,"2020-05-05"]
      -
        columns: ["id int","c1 string","c3 int","c4 bigint","c5 float","c6 double","c7 timestamp","c8 date"]
        indexs: ["index1:c1:c7"]
        rows:
          - [1,"aa",20,30,1.1,2.1,1590738990000,"2020-05-01"]
          - [2,"aa",20,31,1.1,2.1,1590738990001,"2020-05-01"]
          - [3,"bb",20,32,1.1,2.1,1590738990002,"2020-05-01"]
          - [4,"bb",20,33,1.1,2.1,1590738990003,"2020-05-01"]
          - [5,"bb",21,34,1.2,2.2,1590738990004,"2020-05-02"]
    dataProvider:
      - ["ROWS","ROWS_RANGE"]
    sql: |
      select id,{0}.c1,{0}.c3,{1}.c4,
      sum({1}.c4) OVER w1 as w1_c4_sum
      from {0}
      last join {1} ORDER BY {1}.c7 on {0}.c1={1}.c1
      WINDOW
      w1 AS (PARTITION BY c1 ORDER BY c7 d[0] BETWEEN 1 PRECEDING AND CURRENT ROW)
      ;
    expect:
      order: id
      columns: ["id int","c1 string","c3 int","c4 bigint","w1_c4_sum bigint"]
      rows:
        - [1,"aa",20,31,31]
        - [2,"aa",21,31,62]
        - [3,"aa",22,31,62]
        - [4,"bb",23,34,34]
        - [5,"bb",24,34,68]