SQLCases:
  - id: 0
    desc: LAST JOIN 右表未命中索引
    sql: |
      %%fun
      def test(a:i32,b:i32):i32
          c=a+b
          d=c+1
          return d
      end
      %%sql
      SELECT t1.col1 as id, t1.col0 as t1_col0, test(t1.col1,t2.col1) test_col1, t1.col2 as t1_col2, str1 FROM t1
      last join t2 order by t2.col5 on t1.col1=t2.col1 and t1.col5 = t2.col5;
    inputs:
      - name: t1
        schema: col0:string, col1:int32, col2:int16, col3:float, col4:double, col5:int64, col6:string
        index: index2:col2:col5
        data: |
          0, 1, 5, 1.1, 11.1, 1, 1
          0, 2, 5, 2.2, 22.2, 2, 22
          1, 3, 55, 3.3, 33.3, 1, 333
          1, 4, 55, 4.4, 44.4, 2, 4444
          2, 5, 55, 5.5, 55.5, 3, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
      - name: t2
        schema: str0:string, str1:string, col3:float, col4:double, col2:int16, col1:int32, col5:int64
        index: index1:col2:col5
        data: |
          2, EEEEE, 5.5, 55.5, 550, 5, 3
          1, DDDD, 4.4, 44.4, 550, 4, 2
          1, CCC, 3.3, 33.3, 550, 3, 1
          0, BB, 2.2, 22.2, 50, 2, 2
          0, A, 1.1, 11.1, 50, 1, 1
    output:
      schema: id:int32, t1_col0:string, test_col1:int32, t1_col2:int16, str1:string
      order: id
      data: |
        1, 0, 3, 5, A
        2, 0, 5, 5, BB
        3, 1, 7, 55, CCC
        4, 1, 9, 55, DDDD
        5, 2, 11, 55, EEEEE
  - id: 1
    desc: LAST JOIN 右表成功命中索引
    db: db1
    sql: |
      %%fun
      def test(a:i32,b:i32):i32
          c=a+b
          d=c+1
          return d
      end
      %%sql
      SELECT t1.col1 as id, t1.col0 as t1_col0, test(t1.col1,t2.col1) test_col1, t1.col2 as t1_col2, str1 FROM t1
      last join t2 order by t2.col5 on t1.col1=t2.col1 and t1.col5 = t2.col5;

    inputs:
      - name: t1
        schema: col0:string, col1:int32, col2:int16, col3:float, col4:double, col5:int64, col6:string
        index: index2:col2:col5
        data: |
          0, 1, 5, 1.1, 11.1, 1, 1
          0, 2, 5, 2.2, 22.2, 2, 22
          1, 3, 55, 3.3, 33.3, 1, 333
          1, 4, 55, 4.4, 44.4, 2, 4444
          2, 5, 55, 5.5, 55.5, 3, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
      - name: t2
        schema: str0:string, str1:string, col3:float, col4:double, col2:int16, col1:int32, col5:int64
        index: index1:col1:col5
        data: |
          2, EEEEE, 5.5, 55.5, 550, 5, 3
          1, DDDD, 4.4, 44.4, 550, 4, 2
          1, CCC, 3.3, 33.3, 550, 3, 1
          0, BB, 2.2, 22.2, 50, 2, 2
          0, A, 1.1, 11.1, 50, 1, 1
    output:
      schema: id:int32, t1_col0:string, test_col1:int32, t1_col2:int16, str1:string
      order: id
      data: |
        1, 0, 3, 5, A
        2, 0, 5, 5, BB
        3, 1, 7, 55, CCC
        4, 1, 9, 55, DDDD
        5, 2, 11, 55, EEEEE

  - id: 2
    desc: LAST JOIN 右表成功命中一个索引
    db: db1
    sql: |
      %%fun
      def test(a:i32,b:i32):i32
          c=a+b
          d=c+1
          return d
      end
      %%sql
      SELECT t1.col1 as id, t1.col0 as t1_col0, test(t1.col1,t2.col1) test_col1, t1.col2 as t1_col2, str1 FROM t1
      last join t2 order by t2.col5 on t1.col1=t2.col1 and t1.col5 >= t2.col5;

    inputs:
      - name: t1
        schema: col0:string, col1:int32, col2:int16, col3:float, col4:double, col5:int64, col6:string
        index: index2:col2:col5
        data: |
          0, 1, 5, 1.1, 11.1, 1, 1
          0, 2, 5, 2.2, 22.2, 2, 22
          1, 3, 55, 3.3, 33.3, 1, 333
          1, 4, 55, 4.4, 44.4, 2, 4444
          2, 5, 55, 5.5, 55.5, 3, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
      - name: t2
        schema: str0:string, str1:string, col3:float, col4:double, col2:int16, col1:int32, col5:int64
        index: index1:col1:col5
        data: |
          2, EEEEE, 5.5, 55.5, 550, 5, 3
          1, DDDD, 4.4, 44.4, 550, 4, 2
          1, CCC, 3.3, 33.3, 550, 3, 1
          0, BB, 2.2, 22.2, 50, 2, 2
          0, A, 1.1, 11.1, 50, 1, 1
    output:
      schema: id:int32, t1_col0:string, test_col1:int32, t1_col2:int16, str1:string
      order: id
      data: |
        1, 0, 3, 5, A
        2, 0, 5, 5, BB
        3, 1, 7, 55, CCC
        4, 1, 9, 55, DDDD
        5, 2, 11, 55, EEEEE
  - id: 3
    desc: LAST JOIN 拼表条件包含timestamp列
    db: db1
    sql: |
      SELECT t1.col1 as id, t1.col0 as t1_col0, t1.col2 as t1_col2, t1.std_ts as t1_std_ts, str1 FROM t1
      last join t2 order by t2.std_ts on t1.col1=t2.col1 and t1.std_ts = t2.std_ts;
    inputs:
      - name: t1
        resource: cases/resource/simple_t1_ts.yaml
      - name: t2
        schema: str0:string, str1:string,col1:int32, std_ts:timestamp
        index: index1:col1:std_ts
        data: |
          2, EEEEE, 5, 1590115424000
          1, DDDD, 4, 1590115423000
          1, CCC, 3, 1590115422000
          0, BB, 2, 1590115421000
          0, A, 1, 1590115420000
    output:
      schema: id:int32, t1_col0:string, t1_col2:int16, t1_std_ts:timestamp, str1:string
      order: id
      data: |
        1, 0, 5, 1590115420000, A
        2, 0, 5, 1590115421000, BB
        3, 1, 55, 1590115422000, CCC
        4, 1, 55, 1590115423000, DDDD
        5, 2, 55, 1590115424000, EEEEE
  - id: 4
    desc: LAST JOIN 多张表
    db: db1
    sql: |
      SELECT t1.col1 as id, t1.col0, t2.c0, t3.column0 FROM t1
      last join t2 order by t2.c5 on t1.col1=t2.c1
      last join t3 order by t3.column5 on t1.col1 = t3.column1;
    inputs:
      - name: t1
        schema: col0:string, col1:int32, col5:bigint
        index: index2:col1:col5
        data: |
          A, 1, 1
          B, 2, 2
          C, 3, 3
      - name: t2
        schema: c0:string, c1:int32, c5:int64
        index: index1:c1:c5
        data: |
          O, 1, 1
          P, 2, 2
          Q, 3, 3
          R, 4, 4
          S, 5, 5
      - name: t3
        schema: column0:string, column1:int32, column5:int64
        index: index1:column1:column5
        data: |
          X, 1, 1
          Y, 2, 2
          Z, 3, 3
          U, 4, 4
          V, 5, 5
    output:
      schema: id:int32, col0:string, c0:string, column0:string
      order: id
      data: |
        1, A, O, X
        2, B, P, Y
        3, C, Q, Z
  - id: 5
    desc: LAST JOIN 拼表条件包含date列
    db: db1
    sql: |
      SELECT t1.col1 as id, t1.col0 as t1_col0, t1.col2 as t1_col2, t1.std_date as t1_std_date, str1 FROM t1
      last join t2 order by t2.col5 on t1.std_date = t2.std_date;
    inputs:
      - name: t1
        resource: cases/resource/simple_t1_date.yaml
      - name: t2
        schema: str0:string, str1:string, col1:int32, col5:int64, std_date:date
        index: index1:col1:col5
        data: |
          2, EEEEE, 5, 5, 2020-05-24
          1, DDDD, 4, 4, 2020-05-23
          1, CCC, 3, 3, 2020-05-22
          0, BB, 2, 2, 2020-05-21
          0, A, 1, 1, 2020-05-20
    output:
      schema: id:int32, t1_col0:string, t1_col2:int16, t1_std_date:date, str1:string
      order: id
      data: |
        1, 0, 5, 2020-05-20, A
        2, 0, 5, 2020-05-21, BB
        3, 1, 55, 2020-05-22, CCC
        4, 1, 55, 2020-05-23, DDDD
        5, 2, 55, 2020-05-24, EEEEE
  - id: 6
    desc: LAST JOIN 命中多个Key取Last Order
    db: db1
    sql: |
      SELECT t1.col1 as id, t1.col0 as t1_col0, t1.col2 as t1_col2, t1.std_ts as t1_std_ts, t2.std_ts as t2_std_ts, str1 FROM t1
      last join t2 order by t2.std_ts on t1.col1=t2.col1 and t1.std_ts >= t2.std_ts;
    inputs:
      - name: t1
        resource: cases/resource/simple_t1_ts.yaml
      - name: t2
        schema: str0:string, str1:string,col1:int32, std_ts:timestamp
        index: index1:col1:std_ts
        data: |
          2, GGGGGGG, 5, 1590115428000
          2, FFFFFF, 5, 1590115423900
          2, EEEEE, 5, 1590115427000
          1, DDDD, 4, 1590115423000
          1, CCC, 3, 1590115422000
          0, BB, 2, 1590115421000
          0, A, 1, 1590115420000
    output:
      schema: id:int32, t1_col0:string, t1_col2:int16, t1_std_ts:timestamp, t2_std_ts:timestamp, str1:string
      order: id
      data: |
        1, 0, 5, 1590115420000, 1590115420000, A
        2, 0, 5, 1590115421000, 1590115421000, BB
        3, 1, 55, 1590115422000, 1590115422000, CCC
        4, 1, 55, 1590115423000, 1590115423000, DDDD
        5, 2, 55, 1590115424000, 1590115423900, FFFFFF
  - id: 7
    desc: LAST JOIN 命中多个Key取Last Order，使用asc order
    db: db1
    sql: |
      SELECT t1.col1 as id, t1.col0 as t1_col0, t2.std_ts as t2_std_ts FROM t1
      last join t2 order by t2.std_ts asc on t1.col0=t2.col1;
    inputs:
      - name: t1
        resource: cases/resource/simple_t1_ts.yaml
      - name: t2
        schema: str0:string, str1:string, col1:string, std_ts:timestamp
        index: index1:col1:std_ts
        data: |
          2, GGGGGGG, 0, 1590115428000
          2, FFFFFF, 2, 1590115423900
          2, EEEEEE, 2, 1590115427000
          1, DDDD, 4, 1590115423000
          1, CCC, 3, 1590115422000
          0, BB, 5, 1590115421000
          0, A, 1, 1590115420000
    output:
      schema: id:int32, t1_col0:string, t2_std_ts:timestamp
      order: id
      data: |
        1, 0, 1590115428000
        2, 0, 1590115428000
        3, 1, 1590115420000
        4, 1, 1590115420000
        5, 2, 1590115427000
