image: develop-registry.4pd.io/centos6_gcc7_build_env:0.5.1
services:
    - docker:dind
variables:
    GIT_SUBMODULE_STRATEGY: recursive
stages:
    - build
    - test
    - ts_integration_test
    - ns_integration_test
    - deploy

build:
    stage: build
    script:
        - source /root/.bashrc && sh tools/install_fesql.sh
        - ln -sf /depends/thirdparty thirdparty
        - ln -sf /depends/thirdsrc thirdsrc
        - source /root/.bashrc && bash steps/simple_compile.sh
    artifacts:
        expire_in: 2h
        paths:
            - build/bin/rtidb

auto_test:
  stage: test
  before_script:
      - mkdir /rambuild
      - mount -t tmpfs -o size=3G tmpfs /rambuild
  script:
      - ln -sf /depends/thirdparty thirdparty
      - ln -sf /depends/thirdsrc thirdsrc
      - source /root/.bashrc && bash steps/auto_test.sh
  after_script:
      - tar czvf $CI_COMMIT_SHA rtidb-auto-test-java/target/allure-results
      - bash steps/upload-nexus.sh $CI_COMMIT_SHA
      - curl -s "http://auto.4paradigm.com/job/rtidb-test-report/buildWithParameters?token=gitlab&allure_path=rtidb-auto-test-java/target/allure-results&pkg=$CI_COMMIT_SHA&buildname=$CI_PIPELINE_ID"-"$CI_JOB_ID"
      - bash steps/get-report-url.sh rtidb-test-report $CI_PIPELINE_ID"-"$CI_JOB_ID
  artifacts:
      reports:
          junit:
              - java/target/surefire-reports/junitreports/TEST-*.xml
              - java/target/surefire-reports/TEST-*.xml
              - java/target/failsafe-reports/junitreports/TEST-*.xml
              - java/target/failsafe-reports/TEST-*.xml
              - rtidb-auto-test/target/surefire-reports/junitreports/TEST-*.xml
              - rtidb-auto-test/target/surefire-reports/TEST-*.xml
              - rtidb-auto-test/target/failsafe-reports/junitreports/TEST-*.xml
              - rtidb-auto-test/target/failsafe-reports/TEST-*.xml
